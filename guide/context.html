<!DOCTYPE html>
<html lang="en-US">
<head><script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?37d3909d80118e6aa42455324592652d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>上下文 | 炸毛框架</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="协程、高性能、多平台的 Web 机器人框架">
    <meta name="theme-color" content="#5546a3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#00aba9">
    
    <link rel="preload" href="/assets/css/0.styles.fdaceefd.css" as="style"><link rel="preload" href="/assets/js/app.b79f3c5a.js" as="script"><link rel="preload" href="/assets/js/2.5fa68601.js" as="script"><link rel="preload" href="/assets/js/27.5b11cbbd.js" as="script"><link rel="prefetch" href="/assets/js/10.da472d82.js"><link rel="prefetch" href="/assets/js/11.dc788cd6.js"><link rel="prefetch" href="/assets/js/12.515bda46.js"><link rel="prefetch" href="/assets/js/13.3d7ab37d.js"><link rel="prefetch" href="/assets/js/14.3a12afcf.js"><link rel="prefetch" href="/assets/js/15.0abb55d4.js"><link rel="prefetch" href="/assets/js/16.bf0a9325.js"><link rel="prefetch" href="/assets/js/17.523db1ca.js"><link rel="prefetch" href="/assets/js/18.03fc0c07.js"><link rel="prefetch" href="/assets/js/19.ebdc51ca.js"><link rel="prefetch" href="/assets/js/20.584fea75.js"><link rel="prefetch" href="/assets/js/21.12657a59.js"><link rel="prefetch" href="/assets/js/22.0693e97c.js"><link rel="prefetch" href="/assets/js/23.905272da.js"><link rel="prefetch" href="/assets/js/24.8396e24d.js"><link rel="prefetch" href="/assets/js/25.04f7e051.js"><link rel="prefetch" href="/assets/js/26.db48b8c2.js"><link rel="prefetch" href="/assets/js/28.85b77ffb.js"><link rel="prefetch" href="/assets/js/29.bab95703.js"><link rel="prefetch" href="/assets/js/3.6fcb1023.js"><link rel="prefetch" href="/assets/js/30.59096772.js"><link rel="prefetch" href="/assets/js/31.3473e191.js"><link rel="prefetch" href="/assets/js/32.4c5d54ca.js"><link rel="prefetch" href="/assets/js/33.abba5b8b.js"><link rel="prefetch" href="/assets/js/34.02d351e7.js"><link rel="prefetch" href="/assets/js/35.a9c2d2ac.js"><link rel="prefetch" href="/assets/js/36.611b86b4.js"><link rel="prefetch" href="/assets/js/37.dc4ddfca.js"><link rel="prefetch" href="/assets/js/38.dfdccdff.js"><link rel="prefetch" href="/assets/js/39.26ff53d5.js"><link rel="prefetch" href="/assets/js/4.cea7c2bf.js"><link rel="prefetch" href="/assets/js/40.189fdaad.js"><link rel="prefetch" href="/assets/js/5.c16cd7c2.js"><link rel="prefetch" href="/assets/js/6.fba3d83d.js"><link rel="prefetch" href="/assets/js/7.4cbc6cf9.js"><link rel="prefetch" href="/assets/js/8.951b0c9b.js"><link rel="prefetch" href="/assets/js/9.fd10e691.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fdaceefd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">炸毛框架</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link">
  进阶
</a></div><div class="nav-item"><a href="/FAQ.html" class="nav-link">
  FAQ
</a></div><div class="nav-item"><a href="/update.html" class="nav-link">
  更新日志
</a></div><div class="nav-item"><a href="https://docs-v2.zhamao.xin/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  炸毛框架v2
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zhamao-robot/zhamao-framework" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link">
  进阶
</a></div><div class="nav-item"><a href="/FAQ.html" class="nav-link">
  FAQ
</a></div><div class="nav-item"><a href="/update.html" class="nav-link">
  更新日志
</a></div><div class="nav-item"><a href="https://docs-v2.zhamao.xin/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  炸毛框架v2
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zhamao-robot/zhamao-framework" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/guide/installation.html" class="sidebar-link">安装</a></li><li><a href="/guide/quick-start.html" class="sidebar-link">快速开始</a></li><li><a href="/guide/dir-tree.html" class="sidebar-link">目录结构</a></li><li><a href="/guide/configuration.html" class="sidebar-link">配置文件</a></li><li><a href="/guide/create-module.html" class="sidebar-link">编写模块</a></li><li><a href="/guide/context.html" aria-current="page" class="active sidebar-link">上下文</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/context.html#getserver" class="sidebar-link">getServer()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getframe" class="sidebar-link">getFrame()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getfd" class="sidebar-link">getFd()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getdata" class="sidebar-link">getData()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getrequest" class="sidebar-link">getRequest()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getresponse" class="sidebar-link">getResponse()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getconnection" class="sidebar-link">getConnection()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getcid" class="sidebar-link">getCid()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getrobot" class="sidebar-link">getRobot()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getmessage" class="sidebar-link">getMessage()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getuserid" class="sidebar-link">getUserId()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getgroupid" class="sidebar-link">getGroupId()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getdiscussid" class="sidebar-link">getDiscussId()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getmessagetype" class="sidebar-link">getMessageType()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getrobotid" class="sidebar-link">getRobotId()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#setmessage" class="sidebar-link">setMessage()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#setuserid" class="sidebar-link">setUserId()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#setgroupid" class="sidebar-link">setGroupId()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#setdiscussid" class="sidebar-link">setDiscussId()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#setmessagetype" class="sidebar-link">setMessageType()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#setdata" class="sidebar-link">setData()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getcache" class="sidebar-link">getCache()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#setcache" class="sidebar-link">setCache()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#reply" class="sidebar-link">reply()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#finalreply" class="sidebar-link">finalReply()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#waitmessage" class="sidebar-link">waitMessage()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#getargs" class="sidebar-link">getArgs()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#copy" class="sidebar-link">copy()</a></li><li class="sidebar-sub-header"><a href="/guide/context.html#模块阻断" class="sidebar-link">模块阻断</a></li></ul></li><li><a href="/guide/http-server.html" class="sidebar-link">HTTP 服务器</a></li><li><a href="/guide/database.html" class="sidebar-link">数据库</a></li><li><a href="/guide/websocket-server.html" class="sidebar-link">WebSocket 服务器</a></li><li><a href="/guide/debugger.html" class="sidebar-link">调试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>注解事件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/event/" class="sidebar-link">注解事件概念</a></li><li><a href="/guide/event/CQ.html" class="sidebar-link">QQ 机器人事件和注解</a></li><li><a href="/guide/event/swoole.html" class="sidebar-link">Swoole 事件注解</a></li><li><a href="/guide/event/module.html" class="sidebar-link">模块类修饰注解</a></li><li><a href="/guide/event/middleware.html" class="sidebar-link">中间件注解</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>框架组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/component/" class="sidebar-link">框架组件</a></li><li><a href="/guide/component/zmrobot.html" class="sidebar-link">ZMRobot</a></li><li><a href="/guide/component/cqapi.html" class="sidebar-link">CQAPI</a></li><li><a href="/guide/component/cqcode.html" class="sidebar-link">CQ 码</a></li><li><a href="/guide/component/data-provider.html" class="sidebar-link">DataProvider</a></li><li><a href="/guide/component/console.html" class="sidebar-link">Console 控制台</a></li><li><a href="/guide/component/zmutil.html" class="sidebar-link">ZMUtil 杂项</a></li><li><a href="/guide/component/global-functions.html" class="sidebar-link">全局函数</a></li><li><a href="/guide/component/zmbuf.html" class="sidebar-link">ZMBuf 缓存类</a></li><li><a href="/guide/component/save-buffer.html" class="sidebar-link">自动保存的缓存变量</a></li><li><a href="/guide/component/zmrequest.html" class="sidebar-link">ZMRequest HTTP 客户端</a></li><li><a href="/guide/component/zmwebsocket.html" class="sidebar-link">ZMWebSocket 客户端</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="上下文"><a href="#上下文" class="header-anchor">#</a> 上下文</h1> <p>上下文作为整个框架中最重要的内容之一，请务必理解和完整地阅读此部分！</p> <p>一个上下文描述了一个事件和所关联的对象的环境。例如：你在处理 HTTP 请求的 <code>@RequestMapping</code> 绑定的事件中，你需要获取请求的 HTTP 头和 Cookie，再比如你在处理 QQ 机器人发来的命令 <code>@CQCommand(&quot;随机数&quot;)</code> 的时候，在这个方法内，你需要获取发来的人的 QQ 号码。以上我们将处理以上运行环境的对象叫做上下文。</p> <p>由于 Swoole 的协程加持，我们利用了协程 ID 绑定对象来进行构造上下文。</p> <p>以默认的机器人收发消息为例，通过对默认模块的了解，我们可以知道，在绑定 <code>@CQCommand</code> 等类似事件后，你可以用上下文获取发来这条消息的人的 QQ 号码：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @CQCommand(&quot;你好&quot;)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$user_id</span> <span class="token operator">=</span> <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">reply</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;你好啊，&quot;</span><span class="token punctuation">.</span><span class="token variable">$user_id</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;，很高兴认识你！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>context()</code> 就是获取上下文对象的全局函数，它还有简写：<code>ctx()</code>。</p> <p>当然，上下文中的方法不是每个都能在任何时候使用的。例如 <code>getUserId()</code> 你不能在 <code>@RequestMapping</code> 注解的函数中使用，因为它不是机器人消息的上下文。下面说明上下文对象的方法中，每个都会说明每个方法可以在哪些事件中使用：</p> <h2 id="getserver"><a href="#getserver" class="header-anchor">#</a> getServer()</h2> <p>获取 Swoole WebSocker Server 对象。此对象是 Swoole 的对象，详情见 <a href="https://wiki.swoole.com/#/websocket_server" target="_blank" rel="noopener noreferrer">Swoole 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>可以使用的事件：<code>@SwooleEventAt(&quot;message&quot;)</code>，<code>@SwooleEventAt(&quot;open&quot;)</code>，<code>@SwooleEventAt(&quot;close&quot;)</code>，<code>@OnStart()</code> 以及所有 HTTP API 发来的事件：<code>@CQCommand()</code>，<code>@CQMessage()</code> 等。</p> <h2 id="getframe"><a href="#getframe" class="header-anchor">#</a> getFrame()</h2> <p>获取 <code>\Swoole\Websocket\Frame</code> 对象，此对象是 Swoole 的对象，详情见 <a href="https://wiki.swoole.com/#/websocket_server?id=swoolewebsocketframe" target="_blank" rel="noopener noreferrer">Swoole 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>可以使用的事件：<code>@SwooleEventAt(&quot;message&quot;)</code> 以及所有 HTTP API 发来的事件：<code>@CQCommand()</code>，<code>@CQMessage()</code> 等，</p> <h2 id="getfd"><a href="#getfd" class="header-anchor">#</a> getFd()</h2> <p>获取当前连入 Swoole 服务器的连接 fd 号。返回 int。</p> <p>可以使用的事件：所有 <strong>getFrame()</strong> 可以使用的，<code>@SwooleEventAt(&quot;open&quot;)</code>，<code>@SwooleEventAt(&quot;close&quot;)</code></p> <h2 id="getdata"><a href="#getdata" class="header-anchor">#</a> getData()</h2> <p>返回 CQHTTP 事件上报的原始数据包，已经被解析成数组，可以直接操作。</p> <p>可以使用的事件：所有 HTTP API 发来的事件：<code>@CQCommand()</code>，<code>@CQMessage()</code> 等。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @CQMessage()
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Console<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;消息类型是：&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;message_type&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="getrequest"><a href="#getrequest" class="header-anchor">#</a> getRequest()</h2> <p>返回 <code>\Swoole\Http\Request</code> 对象，可在 <code>@RequestMapping</code> 中使用，获取 Cookie，请求头，GET 参数什么的。<a href="https://wiki.swoole.com/#/http_server?id=httprequest" target="_blank" rel="noopener noreferrer">Swoole 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>可以使用的事件：<code>@RequestMapping()</code>，<code>@SwooleEventAt(&quot;request&quot;)</code>，<code>@SwooleEventAt(&quot;open&quot;)</code>。</p> <h2 id="getresponse"><a href="#getresponse" class="header-anchor">#</a> getResponse()</h2> <p>返回 <code>\Swoole\Http\Response</code> 对象的增强版，可在 HTTP 请求相关的事件中使用，返回内容和设置 Cookie 什么的。<a href="https://wiki.swoole.com/#/http_server?id=httpresponse" target="_blank" rel="noopener noreferrer">Swoole 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>可以使用的事件：<code>@RequestMapping()</code>，<code>@SwooleEventAt(&quot;request&quot;)</code>。</p> <p>下面是使用以上两个功能的组合示例：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @RequestMapping(&quot;/ping&quot;)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">get</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;name&quot;</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token double-quoted-string string">&quot;unknown&quot;</span><span class="token punctuation">;</span>
  <span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Hello &quot;</span><span class="token punctuation">.</span><span class="token variable">$name</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="getconnection"><a href="#getconnection" class="header-anchor">#</a> getConnection()</h2> <p>返回此上下文相关联的 <code>WSConnection</code> 对象。此对象详情在 <a href="/guide/websocket-server.html#连接对象">这里</a>。</p> <p>可以使用的事件：所有 <strong>getFrame()</strong> 可以使用的。</p> <h2 id="getcid"><a href="#getcid" class="header-anchor">#</a> getCid()</h2> <p>返回当前上下文所绑定的协程 ID，不出意外的话此 ID 和 <code>\Co::getCid()</code> 返回值一样。</p> <h2 id="getrobot"><a href="#getrobot" class="header-anchor">#</a> getRobot()</h2> <p>返回当前上下文关联的机器人 API 调用对象 <a href="/guide/component/zmrobot.html">ZMRobot</a>。</p> <p>可以使用的事件：所有 HTTP API 发来的事件：<code>@CQCommand()</code>，<code>@CQMessage()</code> 等。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getRobot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sendPrivateMsg</span><span class="token punctuation">(</span><span class="token number">123456</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;发送私聊消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="getmessage"><a href="#getmessage" class="header-anchor">#</a> getMessage()</h2> <p>获取 data 数据中的 <code>message</code> 消息。</p> <p>可以使用的事件：<code>@CQCommand()</code>，<code>@CQMessage</code>，<code>@CQBefore(&quot;message&quot;)</code>，<code>@CQAfter(&quot;message&quot;)</code></p> <h2 id="getuserid"><a href="#getuserid" class="header-anchor">#</a> getUserId()</h2> <p>获取发消息的用户的 QQ 号码。</p> <p>可以使用的事件：所有 <strong>含有</strong> <code>user_id</code> 上报参数的 CQHTTP 事件。<a href="https://cqhttp.cc/docs/#/Post" target="_blank" rel="noopener noreferrer">CQHTTP - 事件上报<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="getgroupid"><a href="#getgroupid" class="header-anchor">#</a> getGroupId()</h2> <p>获取发消息来自的 QQ 群号。</p> <p>可以使用的事件：所有含有 <code>group_id</code> 上报参数的 CQHTTP 事件。<a href="https://cqhttp.cc/docs/#/Post" target="_blank" rel="noopener noreferrer">CQHTTP - 事件上报<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="getdiscussid"><a href="#getdiscussid" class="header-anchor">#</a> getDiscussId()</h2> <p>获取发消息来自的 QQ 讨论组 ID 号。</p> <p>可以使用的事件：所有含有 <code>discuss_id</code> 上报参数的 CQHTTP 事件。<a href="https://cqhttp.cc/docs/#/Post" target="_blank" rel="noopener noreferrer">CQHTTP - 事件上报<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="getmessagetype"><a href="#getmessagetype" class="header-anchor">#</a> getMessageType()</h2> <p>获取消息类型，同参数 <code>message_type</code>。</p> <p>可以使用的事件：所有 <code>post_type</code> 为 <code>message</code> 的响应事件，如 <code>@CQMessage</code>，<code>@CQCommand</code>。</p> <h2 id="getrobotid"><a href="#getrobotid" class="header-anchor">#</a> getRobotId()</h2> <p>获取事件上报的机器人自己的 QQ 号码。</p> <p>可以使用的事件：所有 HTTP API 发来的事件：<code>@CQCommand()</code>，<code>@CQNotice()</code> 等。</p> <h2 id="setmessage"><a href="#setmessage" class="header-anchor">#</a> setMessage()</h2> <p>与 <code>getMessage()</code> 对应，用于更改上下文中保存的事件信息，可以用于消息变更和过滤。</p> <h2 id="setuserid"><a href="#setuserid" class="header-anchor">#</a> setUserId()</h2> <p>与上同理，更改 <code>user_id</code>。</p> <h2 id="setgroupid"><a href="#setgroupid" class="header-anchor">#</a> setGroupId()</h2> <p>与上同理。</p> <h2 id="setdiscussid"><a href="#setdiscussid" class="header-anchor">#</a> setDiscussId()</h2> <p>与上同理。</p> <h2 id="setmessagetype"><a href="#setmessagetype" class="header-anchor">#</a> setMessageType()</h2> <p>与上同理，修改消息类型。</p> <h2 id="setdata"><a href="#setdata" class="header-anchor">#</a> setData()</h2> <p>与上同理，与 <code>getData()</code> 对应，用于更改上下文中的 <code>data</code>。</p> <h2 id="getcache"><a href="#getcache" class="header-anchor">#</a> getCache()</h2> <p>获取保存在上下文中的临时缓存变量。当相关联的事件结束后，数据会从内存中被释放。用于同一事件的多个函数中的信息传递。</p> <ul><li>参数：<code>$key</code>，缓存变量的键名</li> <li>返回：<code>mixed</code>，存入缓存的变量值。</li></ul> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;block_continue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果变量不存在，则返回 null</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="setcache"><a href="#setcache" class="header-anchor">#</a> setCache()</h2> <p>与 <code>getCache()</code> 对应，是设置内容的。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setCache</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;abc&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;asdasd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;abc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// asdasd</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="reply"><a href="#reply" class="header-anchor">#</a> reply()</h2> <p>快速回复当前用户消息内容。</p> <ul><li>参数1：<code>$msg</code>，字符串，你要回复的消息内容</li> <li>参数2：<code>$yield = false</code>，可选，当为 <code>true</code> 时，会协程等待后返回 <strong>消息回复</strong> 的结果，包括 API 状态码、消息 <code>message_id</code> 等。</li></ul> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$r</span> <span class="token operator">=</span> <span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">reply</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;我又好了。&quot;</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$r</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;retcode&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> Console<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;消息发送成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="finalreply"><a href="#finalreply" class="header-anchor">#</a> finalReply()</h2> <p>快速回复用户消息，并阻止其他模块接下来继续处理此事件。</p> <p>参数同 <code>reply()</code>。</p> <h2 id="waitmessage"><a href="#waitmessage" class="header-anchor">#</a> waitMessage()</h2> <ul><li>参数：<code>waitMessage($prompt = &quot;&quot;, $timeout = 600, $timeout_prompt = &quot;&quot;)</code></li> <li>用途：等待用户输入消息</li></ul> <p><code>$prompt</code> 参数为回复用户的文本内容，<code>$timeout</code> 是等待用户回复的超时时间(秒)，<code>$timeout_prompt</code> 是超时后回复用户的文本。</p> <p>用法示例：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @CQCommand(&quot;自我介绍&quot;)
 */</span>
<span class="token keyword">function</span> <span class="token function">yourName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$r</span> <span class="token operator">=</span> <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">waitMessage</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;你叫啥名字呀？&quot;</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;你都10分钟不理我了，嘤嘤嘤&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">finalReply</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;好的，可爱的机器人记住你叫 &quot;</span><span class="token punctuation">.</span><span class="token variable">$r</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; 啦！以后多聊天哦！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>效果就是，给机器人发送 <code>自我介绍</code> 后，它问你 <code>你叫啥名字呀？</code>，如果你在 10 分钟内回复了机器人，则会回你下面一条句子，如果 10 分钟还没有回复，则机器人会回复你不理你的句子。</p> <h2 id="getargs"><a href="#getargs" class="header-anchor">#</a> getArgs()</h2> <ul><li>参数：<code>getArgs(&amp;$arg, $mode, $prompt_msg)</code></li> <li>用途：是 <code>waitMessage()</code> 的封装，常用于配合 <code>@CQCommand</code> 使用，在 <code>@CQCommand</code> 介绍中就用了此函数，可以看其中的例子。</li></ul> <p><code>$arg</code> 为命令传递进入的参数引用。</p> <p><code>$mode</code> 支持：</p> <ul><li><code>ZM_MATCH_ALL</code>：获取除命令本身外的所有后续内容，例如 <code>疫情 iafwebfuaw 乏味</code>，match 后就会匹配到 <code>iafwebfuaw 乏味</code>。如果触发命令只有参数本身的时候，则调用 <code>waitMessage</code> 等待用户输入参数。</li> <li><code>ZM_MATCH_NUMBER</code>：获取后续参数中第一个数字参数，例如 <code>疫情 北京 123</code>，match 后就会获取到 <code>123</code>。如果触发命令没有数字的时候，则调用 <code>waitMessage</code> 等待用户输入参数。</li> <li><code>ZM_MATCH_FIRST</code>：获取命令后的第一个参数，例如 <code>疫情 北京 123</code>，match 后就会获取到 <code>北京</code>。如果触发命令只有参数本身的时候，则调用 <code>waitMessage</code> 等待用户输入参数。</li></ul> <p><code>$prompt_msg</code>：当遇到等待的时候，向用户发送输入的提醒消息内容，同 <code>waitMesssage</code> 的 <code>$prompt</code>。</p> <h2 id="copy"><a href="#copy" class="header-anchor">#</a> copy()</h2> <p>返回此上下文的所有对象和变量，以数组的形式。</p> <ul><li>返回值：可自行 var_dump 查看。</li></ul> <h2 id="模块阻断"><a href="#模块阻断" class="header-anchor">#</a> 模块阻断</h2> <p>模块阻断指的是，一个事件可能会依次触发多个绑定的方法，如果在执行到前面的方法，不想让后面的方法继续执行，你可以使用这个万金油阻断接下来的其他模块中的函数运行：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setCache</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;block_continue&quot;</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>比如你在设置了多个 <code>@CQMessage()</code>，如果第一个代码里面，执行了模块阻断，则接下来的其他 CQMessage 都不会执行到。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @CQMessage(level=25)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">msg1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setCache</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;block_continue&quot;</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置阻断</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * @CQMessage(level=20)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">msg2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Console<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这个永远不会被执行到</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/8/2020, 6:43:38 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/create-module.html" class="prev">
        编写模块
      </a></span> <span class="next"><a href="/guide/http-server.html">
        HTTP 服务器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b79f3c5a.js" defer></script><script src="/assets/js/2.5fa68601.js" defer></script><script src="/assets/js/27.5b11cbbd.js" defer></script>
  </body>
</html>
