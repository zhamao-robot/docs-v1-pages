<!DOCTYPE html>
<html lang="en-US">
<head><script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?37d3909d80118e6aa42455324592652d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>QQ 机器人事件和注解 | 炸毛框架</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="协程、高性能、多平台的 Web 机器人框架">
    <meta name="theme-color" content="#5546a3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#00aba9">
    
    <link rel="preload" href="/assets/css/0.styles.fdaceefd.css" as="style"><link rel="preload" href="/assets/js/app.b79f3c5a.js" as="script"><link rel="preload" href="/assets/js/2.5fa68601.js" as="script"><link rel="preload" href="/assets/js/32.4c5d54ca.js" as="script"><link rel="prefetch" href="/assets/js/10.da472d82.js"><link rel="prefetch" href="/assets/js/11.dc788cd6.js"><link rel="prefetch" href="/assets/js/12.515bda46.js"><link rel="prefetch" href="/assets/js/13.3d7ab37d.js"><link rel="prefetch" href="/assets/js/14.3a12afcf.js"><link rel="prefetch" href="/assets/js/15.0abb55d4.js"><link rel="prefetch" href="/assets/js/16.bf0a9325.js"><link rel="prefetch" href="/assets/js/17.523db1ca.js"><link rel="prefetch" href="/assets/js/18.03fc0c07.js"><link rel="prefetch" href="/assets/js/19.ebdc51ca.js"><link rel="prefetch" href="/assets/js/20.584fea75.js"><link rel="prefetch" href="/assets/js/21.12657a59.js"><link rel="prefetch" href="/assets/js/22.0693e97c.js"><link rel="prefetch" href="/assets/js/23.905272da.js"><link rel="prefetch" href="/assets/js/24.8396e24d.js"><link rel="prefetch" href="/assets/js/25.04f7e051.js"><link rel="prefetch" href="/assets/js/26.db48b8c2.js"><link rel="prefetch" href="/assets/js/27.5b11cbbd.js"><link rel="prefetch" href="/assets/js/28.85b77ffb.js"><link rel="prefetch" href="/assets/js/29.bab95703.js"><link rel="prefetch" href="/assets/js/3.6fcb1023.js"><link rel="prefetch" href="/assets/js/30.59096772.js"><link rel="prefetch" href="/assets/js/31.3473e191.js"><link rel="prefetch" href="/assets/js/33.abba5b8b.js"><link rel="prefetch" href="/assets/js/34.02d351e7.js"><link rel="prefetch" href="/assets/js/35.a9c2d2ac.js"><link rel="prefetch" href="/assets/js/36.611b86b4.js"><link rel="prefetch" href="/assets/js/37.dc4ddfca.js"><link rel="prefetch" href="/assets/js/38.dfdccdff.js"><link rel="prefetch" href="/assets/js/39.26ff53d5.js"><link rel="prefetch" href="/assets/js/4.cea7c2bf.js"><link rel="prefetch" href="/assets/js/40.189fdaad.js"><link rel="prefetch" href="/assets/js/5.c16cd7c2.js"><link rel="prefetch" href="/assets/js/6.fba3d83d.js"><link rel="prefetch" href="/assets/js/7.4cbc6cf9.js"><link rel="prefetch" href="/assets/js/8.951b0c9b.js"><link rel="prefetch" href="/assets/js/9.fd10e691.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fdaceefd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">炸毛框架</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link">
  进阶
</a></div><div class="nav-item"><a href="/FAQ.html" class="nav-link">
  FAQ
</a></div><div class="nav-item"><a href="/update.html" class="nav-link">
  更新日志
</a></div><div class="nav-item"><a href="https://docs-v2.zhamao.xin/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  炸毛框架v2
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zhamao-robot/zhamao-framework" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link">
  进阶
</a></div><div class="nav-item"><a href="/FAQ.html" class="nav-link">
  FAQ
</a></div><div class="nav-item"><a href="/update.html" class="nav-link">
  更新日志
</a></div><div class="nav-item"><a href="https://docs-v2.zhamao.xin/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  炸毛框架v2
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zhamao-robot/zhamao-framework" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/guide/installation.html" class="sidebar-link">安装</a></li><li><a href="/guide/quick-start.html" class="sidebar-link">快速开始</a></li><li><a href="/guide/dir-tree.html" class="sidebar-link">目录结构</a></li><li><a href="/guide/configuration.html" class="sidebar-link">配置文件</a></li><li><a href="/guide/create-module.html" class="sidebar-link">编写模块</a></li><li><a href="/guide/context.html" class="sidebar-link">上下文</a></li><li><a href="/guide/http-server.html" class="sidebar-link">HTTP 服务器</a></li><li><a href="/guide/database.html" class="sidebar-link">数据库</a></li><li><a href="/guide/websocket-server.html" class="sidebar-link">WebSocket 服务器</a></li><li><a href="/guide/debugger.html" class="sidebar-link">调试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>注解事件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/event/" aria-current="page" class="sidebar-link">注解事件概念</a></li><li><a href="/guide/event/CQ.html" aria-current="page" class="active sidebar-link">QQ 机器人事件和注解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/event/CQ.html#cqmessage" class="sidebar-link">CQMessage()</a></li><li class="sidebar-sub-header"><a href="/guide/event/CQ.html#cqcommand" class="sidebar-link">CQCommand()</a></li><li class="sidebar-sub-header"><a href="/guide/event/CQ.html#cqnotice" class="sidebar-link">CQNotice()</a></li><li class="sidebar-sub-header"><a href="/guide/event/CQ.html#cqrequest" class="sidebar-link">CQRequest()</a></li><li class="sidebar-sub-header"><a href="/guide/event/CQ.html#cqmetaevent" class="sidebar-link">CQMetaEvent()</a></li><li class="sidebar-sub-header"><a href="/guide/event/CQ.html#cqbefore" class="sidebar-link">CQBefore()</a></li><li class="sidebar-sub-header"><a href="/guide/event/CQ.html#cqafter" class="sidebar-link">CQAfter()</a></li><li class="sidebar-sub-header"><a href="/guide/event/CQ.html#cqapisend" class="sidebar-link">CQAPISend()</a></li><li class="sidebar-sub-header"><a href="/guide/event/CQ.html#cqapiresponse" class="sidebar-link">CQAPIResponse()</a></li></ul></li><li><a href="/guide/event/swoole.html" class="sidebar-link">Swoole 事件注解</a></li><li><a href="/guide/event/module.html" class="sidebar-link">模块类修饰注解</a></li><li><a href="/guide/event/middleware.html" class="sidebar-link">中间件注解</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>框架组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/component/" class="sidebar-link">框架组件</a></li><li><a href="/guide/component/zmrobot.html" class="sidebar-link">ZMRobot</a></li><li><a href="/guide/component/cqapi.html" class="sidebar-link">CQAPI</a></li><li><a href="/guide/component/cqcode.html" class="sidebar-link">CQ 码</a></li><li><a href="/guide/component/data-provider.html" class="sidebar-link">DataProvider</a></li><li><a href="/guide/component/console.html" class="sidebar-link">Console 控制台</a></li><li><a href="/guide/component/zmutil.html" class="sidebar-link">ZMUtil 杂项</a></li><li><a href="/guide/component/global-functions.html" class="sidebar-link">全局函数</a></li><li><a href="/guide/component/zmbuf.html" class="sidebar-link">ZMBuf 缓存类</a></li><li><a href="/guide/component/save-buffer.html" class="sidebar-link">自动保存的缓存变量</a></li><li><a href="/guide/component/zmrequest.html" class="sidebar-link">ZMRequest HTTP 客户端</a></li><li><a href="/guide/component/zmwebsocket.html" class="sidebar-link">ZMWebSocket 客户端</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="qq-机器人事件和注解"><a href="#qq-机器人事件和注解" class="header-anchor">#</a> QQ 机器人事件和注解</h1> <p>QQ 机器人事件是指 CQHTTP 插件发来的 Event 事件，被框架处理后触发到单个类中方法的事件。</p> <p>为了便于开发，这里的注解类对应 CQHTTP 插件返回的 <code>post_type</code> 类型，对号入座即可。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>在使用注解绑定事件过程中，如果无 <strong>必需</strong> 参数，可一个参数也不写，效果就是此事件任何情况下都会调用此方法。例如：<code>@CQMessage()</code></p></div> <h2 id="cqmessage"><a href="#cqmessage" class="header-anchor">#</a> CQMessage()</h2> <p>QQ 收到消息后触发的事件对应注解。</p> <ul><li>名称：<code>@CQMessage</code></li> <li>对应 <code>post_type</code>：<code>message</code></li> <li>命名空间：<code>ZM\Annotation\CQ\CQMessage</code></li> <li>用途：当收到 <code>post_type == 'message'</code> 类的事件上报（即用户消息）时触发事件</li></ul> <p>参数和 CQHTTP 插件中提供的文档内支持的参数完全一致，有：</p> <ul><li>*message_type：消息类型，有 <code>private</code>，<code>discuss</code>，<code>group</code></li> <li>user_id，group_id，discuss_id，message，raw_message，level（level 见前面的 Swoole 事件激活写的帮助）</li></ul> <p>下面这个例子的注释用途就是：</p> <ul><li>在用户 QQ 为 <code>123456</code> 的用户私聊给机器人发消息后机器人回复内容。</li> <li>用户发送文字为 <code>hello</code> 时返回 <code>你好啊，xxx</code> 的消息。</li></ul> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Module<span class="token punctuation">\</span>Example</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">ZM<span class="token punctuation">\</span>Annotation<span class="token punctuation">\</span>CQ<span class="token punctuation">\</span>CQMessage</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * @CQMessage(message_type=&quot;private&quot;,user_id=123456)
     */</span>
  	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token double-quoted-string string">&quot;你和机器人私聊发送了这些文本：&quot;</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * @CQMessage(message=&quot;hello&quot;)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token double-quoted-string string">&quot;你好啊，&quot;</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="cqcommand"><a href="#cqcommand" class="header-anchor">#</a> CQCommand()</h2> <p>此注解是对 <code>@CQMessage</code> 类别的再封装，是命令解析格式处理消息的利器。例如，你想写一个疫情上报，指令是 <code>疫情 城市名称</code>，那么此方式来解析用户消息会更加方便。</p> <ul><li>名称：<code>@CQCommand</code></li> <li>命名空间：<code>ZM\Annotation\CQ\CQCommand</code></li> <li>用途：消息指令类上报触发
<ul><li>支持的参数：<code>match</code>，<code>regexMatch</code>，<code>fullMatch</code>，<code>alias</code>，<code>message_type</code>，<code>user_id</code>，<code>group_id</code>，<code>discuss_id</code>，<code>level</code> （有先后顺序）</li></ul></li></ul> <p>我们以参数 <code>match</code> 写一个简单的 demo：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Module<span class="token punctuation">\</span>Example</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">ZM<span class="token punctuation">\</span>Annotation<span class="token punctuation">\</span>CQ<span class="token punctuation">\</span>CQCommand</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * @CQCommand(&quot;疫情&quot;)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">virus</span><span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$city</span> <span class="token operator">=</span> <span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">,</span> <span class="token constant">ZM_MATCH_ALL</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;请输入你的城市名称&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token double-quoted-string string">&quot;城市 &quot;</span><span class="token punctuation">.</span><span class="token variable">$city</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; 的疫情状况如下：&quot;</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;{这里假装是疫情接口返回的数据}&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>而这个时候，框架强大的命令解析和一些特殊的分词方式，效果就是：</p> <ul><li>向机器人发送 <code>疫情 上海</code> 时，机器人会直接给你返回：<code>城市 上海 的疫情状况如下</code></li> <li>向机器人发送 <code>疫情</code> 时，机器人会先提醒你输入你的城市名称，你回复 <code>上海</code>，它就会回复你上海的疫情状况。</li></ul> <p>简单来说，上面涉及了两个新内容，<code>@CQCommand</code> 里面第一个参数 <code>match</code> 的作用是匹配第一个分词 <code>疫情</code>。方法中 <code>$this-&gt;getArgs()</code> 方法是获取指令中的参数，如果参数不存在则回你一条消息后等你输入参数（此方法为模块基类中的方法，具体请见 <a href="/guide/create-module.html#基类方法">模块基类方法</a>）。当然你也可以通过 <code>$arg</code> 变量直接获取框架内部为你切分好的参数数组。比如上述你发送的是 <code>疫情 上海</code>，则此数组内容就是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[
	0 =&gt; &quot;疫情&quot;,
	1 =&gt; &quot;上海&quot;
]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>如果是按照参数的顺序写注解参数的话，可以不写参数的名字，如上方例子，<code>疫情</code> 就是参数 <code>match</code> 。</p> <p>同时 <code>match</code> 参数下的分词逻辑是：文字和数字分割，文字和空格分割，文字和 <code>\t</code> 分割。同时支持多个空格，比如 <code>疫情 (这里假装有一堆空格) 上海</code> 也是同样的效果。</p></div> <p><strong>第二个参数</strong> <code>regexMatch</code> 是按表达式进行匹配文本的命令方式，与 <code>match</code> 参数只能二选一。</p> <p>这里的 <code>regexMatch</code> 匹配不是正则表达式匹配，而是框架支持的一个简单的文字匹配规则表达式。其中表达式规则如下：</p> <ul><li>星号(*) 代表匹配到的参数</li> <li>普通其他文字代表要匹配的文字</li></ul> <p>例如：<code>*疫情怎么样了</code> ，效果就是，<code>上海疫情怎么样了</code> 这么问的时候，参数列表中就是 <code>上海</code>。多个星号就匹配多个参数，可以在文本内任意位置，不可两个星号放在一起匹配。</p> <p><strong>第三个参数</strong> <code>fullMatch</code> 是按全量的正则表达式匹配的结果，可以写正则表达式提取参数进行匹配，下面是个简单的时间匹配的例子：</p> <ul><li>表达式：<code>@CQCommand(fullMatch=&quot;添加提醒 (\d+-\d+-\d+ \d+:\d+) (.*)&quot;)</code></li> <li>可匹配：<code>添加提醒 2020-12-12 23:59 你好嘻嘻哈哈 xxx yyy</code></li></ul> <p>使用例子：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @CQCommand(fullMatch=&quot;添加提醒 (\d+-\d+-\d+ \d+:\d+) (.*)&quot;)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">fullMatchFunc</span><span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// $arg[0] -&gt; &quot;2020-12-12 23:59&quot;</span>
  <span class="token comment">// $arg[1] -&gt; &quot;你好嘻嘻哈哈 xxx yyy&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>fullMatch 在 1.5.8 版本起可用。</p></blockquote> <p><strong>第四个参数</strong> alias 是别名数组，如果有多个别名指令消息需要匹配，则使用即可，注意只可以在使用 match 方式匹配时才能使用 alias：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @CQCommand(match=&quot;你好&quot;,alias={&quot;你好啊&quot;,&quot;你叫啥&quot;,&quot;你是啥&quot;})
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token double-quoted-string string">&quot;你好啊，我叫炸毛机器人！&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>别名在 1.5.4 版本起可用。</p></blockquote> <p>后面几个 message_type 等参数和 <code>@CQMessage</code> 中的限定条件参数作用是一样的，比如你只希望此命令被私聊触发，那么写成 <code>@CQCommand(match=&quot;你好&quot;,message_type=&quot;private&quot;)</code> 。</p> <blockquote><p>后几个限定参数的功能在 1.5.6 版本加入。</p></blockquote> <h2 id="cqnotice"><a href="#cqnotice" class="header-anchor">#</a> CQNotice()</h2> <ul><li>名称：<code>@CQNotice</code></li> <li>对应：<code>post_type</code>：<code>notice</code></li> <li>命名空间：<code>ZM\Annotation\CQ\CQNotice</code></li> <li>用途：当收到 <code>post_type == 'notice'</code> 类的事件上报（即通知）时触发事件</li></ul> <p>参数也和 CQHTTP 插件提供的上报参数一致，有：</p> <ul><li>notice_type，sub_type，group_id，operator_id 等，按需组合使用</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>@CQNotice() //所有通知都触发
@CQNotice(notice_type=&quot;group_increase&quot;) //在群成员增加的通知才触发
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="cqrequest"><a href="#cqrequest" class="header-anchor">#</a> CQRequest()</h2> <ul><li>名称：<code>@CQRequest</code></li> <li>对应 <code>post_type</code>：<code>request</code></li> <li>命名空间：<code>ZM\Annotation\CQ\CQRequest</code></li> <li>用途：当收到 <code>post_type == 'request'</code> 类的事件上报（即请求类事件）时触发</li></ul> <p>参数依然和 CQHTTP 插件提供的上报参数一致，有：</p> <ul><li>request_type，sub_type，user_id，comment，level 等</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>@CQRequest() //所有请求都触发
@CQRequest(request_type=&quot;friend&quot;) //加机器人好友时才触发
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="cqmetaevent"><a href="#cqmetaevent" class="header-anchor">#</a> CQMetaEvent()</h2> <ul><li>名称：<code>@CQMetaEvent</code></li> <li>对应 <code>post_type</code>：<code>meta_event</code></li> <li>命名空间：<code>ZM\Annotation\CQ\CQMetaEvent</code></li> <li>用途：CQHTTP 插件的元事件上报时触发</li></ul> <p>参数列表：<code>meta_event_type</code>，<code>sub_type</code>，<code>level</code>。</p> <h2 id="cqbefore"><a href="#cqbefore" class="header-anchor">#</a> CQBefore()</h2> <ul><li>作用：在以上涉及的事件触发前会触发的事件（预处理，比如过滤消息什么的）</li> <li>名称：<code>@CQBefore</code></li> <li>命名空间：<code>ZM\Annotation\CQ\CQBefore</code></li> <li>参数：<code>cq_event</code>，<code>level</code></li> <li>函数返回值：<code>true</code> 或 <code>false</code>。如果返回 <code>false</code> 则不继续执行其他任何 <code>@CQMessage</code> 注解的函数方法。</li></ul> <p>怎么用？例如在事件 <code>CQMessage</code> 触发前要过滤所有消息含有 <code>谷歌</code> 的消息，不让框架响应：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Module<span class="token punctuation">\</span>Example</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">ZM<span class="token punctuation">\</span>Annotation<span class="token punctuation">\</span>CQ<span class="token punctuation">\</span>CQBefore</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">ZM<span class="token punctuation">\</span>Annotation<span class="token punctuation">\</span>CQ<span class="token punctuation">\</span>CQMessage</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * @CQBefore(&quot;message&quot;)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 可用于敏感词，如政治相关的词语不响应其他模块</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token function">ctx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;谷歌&quot;</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>在设置了 <code>level</code> 参数后，如果设置了多个 <code>@CQBefore</code> 监听事件函数，更高 <code>level</code> 的事件函数返回了 <code>false</code>，则低 <code>level</code> 的绑定函数不会执行，所有 <code>@CQMessage</code> 绑定的事件也不会执行。</p></div> <p>你也可以使用 <code>@CQBefore</code> 做一些消息的转发和过滤。比如你想去除用户发来的文字中的 emoji、图片等 CQ 码，只保留文本：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @CQBefore(&quot;message&quot;)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token constant">CQ</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">removeCQ</span><span class="token punctuation">(</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="cqafter"><a href="#cqafter" class="header-anchor">#</a> CQAfter()</h2> <ul><li>作用：在以上涉及的事件触发后会触发的事件（后期处理，其实没什么用，就是为了对称，有前有后，可自行开发用途）</li> <li>名称：<code>@CQAfter</code></li> <li>命名空间：<code>ZM\Annotation\CQ\CQAfter</code></li> <li>参数：<code>cq_event</code>，<code>level</code></li> <li>函数返回值：<code>true</code> 或 <code>false</code>。如果返回 <code>false</code> 则不继续执行其他低等级的 <code>@CQAfter</code> 绑定的事件函数。</li></ul> <h2 id="cqapisend"><a href="#cqapisend" class="header-anchor">#</a> CQAPISend()</h2> <ul><li>作用：此注解在框架调用 CQHTTP API 接口（即发送消息、请求 API 等操作）时触发，或者可以直接引申理解为：在使用 <code>ZMRobot</code> 组件时触发的注解事件</li> <li>名称：<code>@CQAPISend</code></li> <li>命名空间：<code>ZM\Annotation\CQ\CQAPISend</code></li> <li>参数：<code>action</code>，<code>level</code></li> <li>常见用途：对发送的消息记录 log 日志</li> <li>函数请求参数：<code>logger($action, $params, $self_id)</code>，<code>$action</code> 为调用的 API 名称，<code>$params</code> 为调用的参数，例如发消息时含有参数 <code>[&quot;user_id&quot; =&gt; 123, &quot;message&quot; =&gt; &quot;hahah&quot;]</code>，<code>$self_id</code> 为目标发送的机器人 QQ。</li></ul> <p>参数 <code>action</code> 默认为空，表示所有 API 请求都会触发。如果填写 <code>send_private_msg</code> 等 API 名称，则只对应 API 被调用时触发。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @CQAPISend()
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span> <span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$self_id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;send_private_msg&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;send_group_msg&quot;</span><span class="token punctuation">,</span><span class="token double-quoted-string string">&quot;send_discuss_msg&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	Console<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;机器人 <span class="token interpolation"><span class="token variable">$self_id</span></span> 发送了消息：&quot;</span><span class="token punctuation">.</span><span class="token variable">$params</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;message&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * @CQAPISend(&quot;send_private_msg&quot;)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">sendLogger</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span> <span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$self_id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  Console<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;机器人 <span class="token interpolation"><span class="token variable">$self_id</span></span> 给 &quot;</span><span class="token punctuation">.</span><span class="token variable">$params</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;user_id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot; 私发了消息：&quot;</span><span class="token punctuation">.</span><span class="token variable">$params</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;message&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="cqapiresponse"><a href="#cqapiresponse" class="header-anchor">#</a> CQAPIResponse()</h2> <p>在请求 HTTP API 后返回的状态码对应的触发，多用于错误状态码的事件绑定，每个 <code>retcode</code> 只能全局绑定一个函数。</p> <ul><li>名称：<code>@CQAPIResponse</code></li> <li>命名空间：<code>ZM\Annotation\CQ\CQAPIResponse</code></li> <li>参数：<code>retcode（必需，int类型）</code></li> <li>常见用途：在发送异常后做 log 日志或其他错误报告用途，例如 <strong>-23</strong> （私聊发消息不是好友，没发出去）的绑定，采取 log 日志记录或调用其他途径给用户发消息。</li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>一定要谨慎在此事件的函数下调用 HTTP API（使用 ZMRobot 组件），否则很有可能会产生循环报错！</p></div> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @CQAPIResponse(-23)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">onNoneFriendLog</span><span class="token punctuation">(</span><span class="token variable">$origin</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Console<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;你要发的 \&quot;&quot;</span><span class="token punctuation">.</span><span class="token variable">$origin</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;params&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;message&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;\&quot;，它没发出去，不是好友！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上面的 <code>$origin</code> 参数为请求到 HTTP API 的原始数据数组，<code>$response</code> 为 HTTP API 返回带 <code>retcode</code> 的结果数组。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">6/26/2020, 4:25:09 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/event/" class="prev router-link-active">
        注解事件概念
      </a></span> <span class="next"><a href="/guide/event/swoole.html">
        Swoole 事件注解
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b79f3c5a.js" defer></script><script src="/assets/js/2.5fa68601.js" defer></script><script src="/assets/js/32.4c5d54ca.js" defer></script>
  </body>
</html>
